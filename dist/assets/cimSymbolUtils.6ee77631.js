var $t=Object.defineProperty,wt=Object.defineProperties;var Lt=Object.getOwnPropertyDescriptors;var at=Object.getOwnPropertySymbols;var It=Object.prototype.hasOwnProperty,zt=Object.prototype.propertyIsEnumerable;var lt=(t,i,e)=>i in t?$t(t,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[i]=e,j=(t,i)=>{for(var e in i||(i={}))It.call(i,e)&&lt(t,e,i[e]);if(at)for(var e of at(i))zt.call(i,e)&&lt(t,e,i[e]);return t},D=(t,i)=>wt(t,Lt(i));import{ap as Xt,ar as st,aq as ct,s as Z,e as Q,by as Ht,bR as X,bS as O,b5 as k,r as ft,bT as Jt,bU as Rt,bs as Yt,u as Ft,bV as mt,b9 as At,bW as Tt,k as tt,bX as Et,bY as ut,bZ as yt,b_ as Wt,b$ as jt,c0 as Gt,c1 as Dt}from"./vendor.1906794a.js";import{t as Ut,o as Vt,p as qt,a as Bt,i as pt,k as ht,O as I,R as B}from"./CIMSymbolHelper.96d440ee.js";import{q as Kt,C as _t,B as Zt,v as Qt}from"./quantizationUtils.f38724ee.js";import{E as K}from"./Utils.dc5734bd.js";import{L as te}from"./MaterialKey.301bf49f.js";import{c as ee,a as ie}from"./devEnvironmentUtils.444b8fd1.js";function re(t){if(!t)return null;switch(t.type){case"CIMPointSymbol":{const e=t.symbolLayers;return e&&e.length===1?re(e[0]):null}case"CIMVectorMarker":{var i;const e=t.markerGraphics;if(!e||e.length!==1)return null;const o=e[0];if(!o)return null;const r=o.geometry;if(!r)return null;const n=o.symbol;return!n||n.type!=="CIMPolygonSymbol"&&n.type!=="CIMLineSymbol"||(i=n.symbolLayers)!=null&&i.some(s=>!!s.effects)?null:{geom:r,asFill:n.type==="CIMPolygonSymbol"}}case"sdf":return{geom:t.geom,asFill:t.asFill}}return null}function oe(t){return t?t.rings?t.rings:t.paths?t.paths:t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0?[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]:null:null}function ne(t){let i=1/0,e=-1/0,o=1/0,r=-1/0;for(const n of t)for(const s of n)s[0]<i&&(i=s[0]),s[0]>e&&(e=s[0]),s[1]<o&&(o=s[1]),s[1]>r&&(r=s[1]);return new Ut(i,o,e-i,r-o)}function gt(t){let i=1/0,e=-1/0,o=1/0,r=-1/0;for(const n of t)for(const s of n)s[0]<i&&(i=s[0]),s[0]>e&&(e=s[0]),s[1]<o&&(o=s[1]),s[1]>r&&(r=s[1]);return[i,o,e,r]}function dt(t){return t?t.rings?gt(t.rings):t.paths?gt(t.paths):Xt(t)?[t.xmin,t.ymin,t.xmax,t.ymax]:null:null}function St(t,i,e,o,r){const[n,s,l,c]=t;if(l<n||c<s)return[0,0,0];const f=l-n,m=c-s,y=128,a=1,u=Math.floor(.5*(.5*y-a)),g=(y-2*(u+a))/Math.max(f,m),h=Math.round(f*g)+2*u,S=Math.round(m*g)+2*u;let d=1;i&&(d=S/g/(i.ymax-i.ymin));let v=0,N=0;if(o)if(r){if(i&&e&&i.ymax-i.ymin>0){const b=(i.xmax-i.xmin)/(i.ymax-i.ymin);v=o.x/(e*b),N=o.y/e}}else v=o.x,N=o.y;return v=.5*(i.xmax+i.xmin)+v*(i.xmax-i.xmin),N=.5*(i.ymax+i.ymin)+N*(i.ymax-i.ymin),v-=n,N-=s,v*=g,N*=g,v+=u,N+=u,[d,v/h-.5,-(N/S-.5)]}function De(t){const i=oe(t.geom),e=ne(i),o=128,r=1,n=Math.floor(.5*(.5*o-r)),s=(o-2*(n+r))/Math.max(e.width,e.height),l=Math.round(e.width*s)+2*n,c=Math.round(e.height*s)+2*n,f=[];for(const y of i)if(y&&y.length>1){const a=[];for(const u of y){let[g,h]=u;g-=e.x,h-=e.y,g*=s,h*=s,g+=n-.5,h+=n-.5,t.asFill?a.push([g,h]):a.push([Math.round(g),Math.round(h)])}if(t.asFill){const u=a.length-1;a[0][0]===a[u][0]&&a[0][1]===a[u][1]||a.push(a[0])}f.push(a)}const m=ae(f,l,c,n);return t.asFill&&le(f,l,c,n,m),[se(m,n),l,c]}function ae(t,i,e,o){const r=i*e,n=new Array(r),s=o*o+1;for(let l=0;l<r;++l)n[l]=s;for(const l of t){const c=l.length;for(let f=1;f<c;++f){const m=l[f-1],y=l[f];let a,u,g,h;m[0]<y[0]?(a=m[0],u=y[0]):(a=y[0],u=m[0]),m[1]<y[1]?(g=m[1],h=y[1]):(g=y[1],h=m[1]);let S=Math.floor(a)-o,d=Math.floor(u)+o,v=Math.floor(g)-o,N=Math.floor(h)+o;S<0&&(S=0),d>i&&(d=i),v<0&&(v=0),N>e&&(N=e);const b=y[0]-m[0],M=y[1]-m[1],P=b*b+M*M;for(let x=S;x<d;x++)for(let C=v;C<N;C++){let w,z,L=(x-m[0])*b+(C-m[1])*M;L<0?(w=m[0],z=m[1]):L>P?(w=y[0],z=y[1]):(L/=P,w=m[0]+L*b,z=m[1]+L*M);const F=(x-w)*(x-w)+(C-z)*(C-z),R=(e-C-1)*i+x;F<n[R]&&(n[R]=F)}}}for(let l=0;l<r;++l)n[l]=Math.sqrt(n[l]);return n}function le(t,i,e,o,r){for(const n of t){const s=n.length;for(let l=1;l<s;++l){const c=n[l-1],f=n[l];let m,y,a,u;c[0]<f[0]?(m=c[0],y=f[0]):(m=f[0],y=c[0]),c[1]<f[1]?(a=c[1],u=f[1]):(a=f[1],u=c[1]);let g=Math.floor(m),h=Math.floor(y)+1,S=Math.floor(a),d=Math.floor(u)+1;g<o&&(g=o),h>i-o&&(h=i-o),S<o&&(S=o),d>e-o&&(d=e-o);for(let v=S;v<d;++v){if(c[1]>v==f[1]>v)continue;const N=(e-v-1)*i;for(let b=g;b<h;++b)b<(f[0]-c[0])*(v-c[1])/(f[1]-c[1])+c[0]&&(r[N+b]=-r[N+b]);for(let b=o;b<g;++b)r[N+b]=-r[N+b]}}}}function se(t,i){const e=2*i,o=t.length,r=new Uint8Array(4*o);for(let n=0;n<o;++n){const s=.5-t[n]/e;Vt(s,r,4*n)}return r}const ce=96/72;class bt{static executeEffects(i,e){const o=Bt(e),r=ce;let n=new pt(o);for(const s of i){const l=ht(s);l&&(n=l.execute(n,s,r,!0))}return n}static next(i){const e=i.next();return qt(e),e}static applyEffects(i,e){if(!i)return e;let o=new pt(e);for(const s of i){const l=ht(s);l&&(o=l.execute(o,s,1,!1))}let r,n=null;for(;r=o.next();)n?st(n)?st(r)&&n.paths.push(...r.paths):ct(n)&&ct(r)&&n.rings.push(...r.rings):n=r;return n}}function vt(t,i,e,o,r){const n=t.referencesGeometry()&&r?fe(i,o,r):i,s=t.repurposeFeature(n);try{return t.evaluate(D(j({},e),{$feature:s}))}catch(l){return Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",l),null}}const et=new Map;function fe(t,i,e){const{transform:o,hasZ:r,hasM:n}=e;et.has(i)||et.set(i,me(i));const s=et.get(i)(t.geometry,o,r,n);return D(j({},t),{geometry:s})}function me(t){const i={};switch(t){case"esriGeometryPoint":return(e,o,r,n)=>Qt(o,i,e,r,n);case"esriGeometryPolygon":return(e,o,r,n)=>Zt(o,i,e,r,n);case"esriGeometryPolyline":return(e,o,r,n)=>_t(o,i,e,r,n);case"esriGeometryMultipoint":return(e,o,r,n)=>Kt(o,i,e,r,n);default:return Z.getLogger("esri.views.2d.support.arcadeOnDemand").error(new Q("mapview-arcade",`Unable to handle geometryType: ${t}`)),e=>e}}const Nt=Z.getLogger("esri.symbols.cim.cimAnalyzer");function it(t){switch(t){case"Butt":return 0;case"Square":return 2;default:return 1}}function rt(t){switch(t){case"Bevel":return 0;case"Miter":return 2;default:return 1}}function ue(t){switch(t){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return"justify"}}function ye(t){switch(t){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function pe(t){let i="",e="";if(t){const o=t.toLowerCase();o.indexOf("italic")!==-1?i="italic":o.indexOf("oblique")!==-1&&(i="oblique"),o.indexOf("bold")!==-1?e="bold":o.indexOf("light")!==-1&&(e="lighter")}return{style:i,weight:e}}function he(t){return t.underline?"underline":t.strikethrough?"line-through":"none"}function kt(t,i,e,o){let r;t[i]?r=t[i]:(r={},t[i]=r),r[e]=o}function Ct(t){const i=t.markerPlacement;return i&&i.angleToLine?1:0}async function ge(t,i,e,o,r){const n=o!=null?o:[];if(!t)return n;let s,l;const c={};if(t.type!=="CIMSymbolReference")return Nt.error("Expect cim type to be 'CIMSymbolReference'"),n;if(s=t.symbol,l=t.primitiveOverrides,l){const m=[];for(const y of l){const a=y.valueExpressionInfo;if(a&&i){const u=a.expression,g=Ht(u,i.spatialReference,i.fields).then(h=>{h&&kt(c,y.primitiveName,y.propertyName,h)});m.push(g)}else y.value!=null&&kt(c,y.primitiveName,y.propertyName,y.value)}m.length>0&&await Promise.all(m)}const f=[];switch(Ot(s,e,f),f.length>0&&await Promise.all(f),s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":de(s,l,c,i,n,e,r)}return n}function de(t,i,e,o,r,n,s){if(!t)return;const l=t.symbolLayers;if(!l)return;const c=t.effects;let f;const m=I.getSize(t);t.type==="CIMPointSymbol"&&t.angleAlignment==="Map"&&(f=1);let y=l.length;for(;y--;){const a=l[y];if(!a||a.enable===!1)continue;let u;c&&c.length&&(u=[...c]);const g=a.effects;g&&g.length&&(c?u.push(...g):u=[...g]);const h=[];switch(B.findApplicableOverrides(a,i,h),a.type){case"CIMSolidFill":Se(a,u,e,h,o,r);break;case"CIMPictureFill":be(a,u,e,h,o,n,r);break;case"CIMHatchFill":ve(a,u,e,h,o,r);break;case"CIMGradientFill":Ne(a,u,e,h,o,r);break;case"CIMSolidStroke":ke(a,u,e,h,o,r,t.type==="CIMPolygonSymbol",m);break;case"CIMPictureStroke":Ce(a,u,e,h,o,r,t.type==="CIMPolygonSymbol",m);break;case"CIMGradientStroke":xe(a,u,e,h,o,r,t.type==="CIMPolygonSymbol",m);break;case"CIMCharacterMarker":if(ot(a,u,e,h,o,r))break;break;case"CIMPictureMarker":if(ot(a,u,e,h,o,r))break;t.type==="CIMLineSymbol"&&(f=Ct(a)),Oe(a,u,e,h,o,n,r,f,m);break;case"CIMVectorMarker":if(ot(a,u,e,h,o,r))break;t.type==="CIMLineSymbol"&&(f=Ct(a)),Me(a,u,e,h,o,r,n,f,m,s);break;default:Nt.error("Cannot analyze CIM layer",a.type)}}}function Se(t,i,e,o,r,n){const s=t.primitiveName,l=X(t.color),[c,f]=J(o,s),m=O(JSON.stringify(t)+f).toString();n.push({type:"fill",templateHash:m,materialHash:c?()=>m:m,cim:t,materialOverrides:null,colorLocked:t.colorLocked,color:p(s,e,"Color",r,l,Y),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:i})}function be(t,i,e,o,r,n,s){const l=t.primitiveName,c=t.tintColor?X(t.tintColor):{r:255,g:255,b:255,a:1},[f,m]=J(o,l),y=O(JSON.stringify(t)+m).toString(),a=O(`${t.url}${JSON.stringify(t.colorSubstitutions)}`).toString();let u=k(t.scaleX);if("width"in t){const g=t.width;let h=1;const S=n.getResource(t.url);ft(S)&&(h=S.width/S.height),u/=h*(t.height/g)}s.push({type:"fill",templateHash:y,materialHash:f?()=>a:a,cim:t,materialOverrides:null,colorLocked:t.colorLocked,effects:i,color:p(l,e,"TintColor",r,c,Y),height:p(l,e,"Height",r,t.height),scaleX:p(l,e,"ScaleX",r,u),angle:p(l,e,"Rotation",r,k(t.rotation)),offsetX:p(l,e,"OffsetX",r,k(t.offsetX)),offsetY:p(l,e,"OffsetY",r,k(t.offsetY)),url:t.url})}function ve(t,i,e,o,r,n){const s=["Rotation","OffsetX","OffsetY"],l=o.filter(u=>u.primitiveName!==t.primitiveName&&s.indexOf(u.propertyName)===-1),c=t.primitiveName,[f,m]=J(o,c),y=O(JSON.stringify(t)+m).toString(),a=O(`${t.separation}${JSON.stringify(t.lineSymbol)}`).toString();n.push({type:"fill",templateHash:y,materialHash:f?U(a,e,l,r):a,cim:t,materialOverrides:l,colorLocked:t.colorLocked,effects:i,color:{r:255,g:255,b:255,a:1},height:p(c,e,"Separation",r,t.separation),scaleX:1,angle:p(c,e,"Rotation",r,k(t.rotation)),offsetX:p(c,e,"OffsetX",r,k(t.offsetX)),offsetY:p(c,e,"OffsetY",r,k(t.offsetY))})}function Ne(t,i,e,o,r,n){const s=t.primitiveName,[l,c]=J(o,s),f=O(JSON.stringify(t)+c).toString();n.push({type:"fill",templateHash:f,materialHash:l?U(f,e,o,r):f,cim:t,materialOverrides:null,colorLocked:t.colorLocked,effects:i,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1})}function ke(t,i,e,o,r,n,s,l){const c=t.primitiveName,f=X(t.color),m=t.width!==void 0?t.width:4,y=it(t.capStyle),a=rt(t.joinStyle),u=t.miterLimit,[g,h]=J(o,c),S=O(JSON.stringify(t)+h).toString();let d,v;if(i&&i.length>0){const N=i[i.length-1];if(N.type==="CIMGeometricEffectDashes"&&N.lineDashEnding==="NoConstraint"){const b=(i=[...t.effects]).pop();d=b.dashTemplate,v=b.scaleDash}}n.push({type:"line",templateHash:S,materialHash:g?()=>S:S,cim:t,materialOverrides:null,isOutline:s,colorLocked:t.colorLocked,effects:i,color:p(c,e,"Color",r,f,Y),width:p(c,e,"Width",r,m),cap:p(c,e,"CapStyle",r,y),join:p(c,e,"JoinStyle",r,a),miterLimit:p(c,e,"MiterLimit",r,u),referenceWidth:l,zOrder:nt(t.name),dashTemplate:d,scaleDash:v})}function Ce(t,i,e,o,r,n,s,l){const c=O(`${t.url}${JSON.stringify(t.colorSubstitutions)}`).toString(),f=t.primitiveName,m=X(t.tintColor),y=t.width!==void 0?t.width:4,a=it(t.capStyle),u=rt(t.joinStyle),g=t.miterLimit,[h,S]=J(o,f),d=O(JSON.stringify(t)+S).toString();n.push({type:"line",templateHash:d,materialHash:h?()=>c:c,cim:t,materialOverrides:null,isOutline:s,colorLocked:t.colorLocked,effects:i,color:p(f,e,"TintColor",r,m,Y),width:p(f,e,"Width",r,y),cap:p(f,e,"CapStyle",r,a),join:p(f,e,"JoinStyle",r,u),miterLimit:p(f,e,"MiterLimit",r,g),referenceWidth:l,zOrder:nt(t.name),dashTemplate:null,scaleDash:!1,url:t.url})}function xe(t,i,e,o,r,n,s,l){const c=t.primitiveName,f=t.width!==void 0?t.width:4,m=it(t.capStyle),y=rt(t.joinStyle),a=t.miterLimit,[u,g]=J(o,c),h=O(JSON.stringify(t)+g).toString();n.push({type:"line",templateHash:h,materialHash:u?U(h,e,o,r):h,cim:t,materialOverrides:null,isOutline:s,colorLocked:t.colorLocked,effects:i,color:{r:128,g:128,b:128,a:1},width:p(c,e,"Width",r,f),cap:p(c,e,"CapStyle",r,m),join:p(c,e,"JoinStyle",r,y),miterLimit:p(c,e,"MiterLimit",r,a),referenceWidth:l,zOrder:nt(t.name),dashTemplate:null,scaleDash:!1})}function ot(t,i,e,o,r,n){const s=t.markerPlacement;if(!s||s.type!=="CIMMarkerPlacementInsidePolygon")return!1;const l=s,c=["Rotation","OffsetX","OffsetY"],f=o.filter(d=>d.primitiveName!==t.primitiveName&&c.indexOf(d.propertyName)===-1),m="url"in t?t.url:null,[y,a]=J(o,l.primitiveName),u=O(JSON.stringify(t)+a).toString();let g=l.stepY,h=null,S=1;return s.shiftOddRows&&(g*=2,h=function(d){return d?2*d:0},S=.5),n.push({type:"fill",templateHash:u,materialHash:y?U(u,e,f,r):u,cim:t,materialOverrides:f,colorLocked:t.colorLocked,effects:i,color:{r:255,g:255,b:255,a:1},height:p(l.primitiveName,e,"StepY",r,g,h),scaleX:S,angle:p(l.primitiveName,e,"GridAngle",r,l.gridAngle),offsetX:p(l.primitiveName,e,"OffsetX",r,k(l.offsetX)),offsetY:p(l.primitiveName,e,"OffsetY",r,k(l.offsetY)),url:m}),!0}function Oe(t,i,e,o,r,n,s,l,c){var f;const m=t.primitiveName,y=k(t.size);let a=k(t.scaleX);const u=k(t.rotation),g=k(t.offsetX),h=k(t.offsetY),S=t.tintColor?X(t.tintColor):{r:255,g:255,b:255,a:1},d=O(`${t.url}${JSON.stringify(t.colorSubstitutions)}`).toString(),[v,N]=J(o,m),b=O(JSON.stringify(t)+N).toString(),M=(f=t.anchorPoint)!=null?f:{x:0,y:0};if("width"in t){const P=t.width;let x=1;const C=n.getResource(t.url);ft(C)&&(x=C.width/C.height),a/=x*(y/P)}s.push({type:"marker",templateHash:b,materialHash:v?()=>d:d,cim:t,materialOverrides:null,colorLocked:t.colorLocked,effects:i,scaleSymbolsProportionally:!1,alignment:l,size:p(m,e,"Size",r,y),scaleX:p(m,e,"ScaleX",r,a),rotation:p(m,e,"Rotation",r,u),offsetX:p(m,e,"OffsetX",r,g),offsetY:p(m,e,"OffsetY",r,h),color:p(m,e,"TintColor",r,S,Y),anchorPoint:{x:M.x,y:-M.y},isAbsoluteAnchorPoint:t.anchorPointUnits!=="Relative",outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:t.rotateClockwise,referenceSize:c,sizeRatio:1,markerPlacement:t.markerPlacement,url:t.url})}function Me(t,i,e,o,r,n,s,l,c,f){const m=t.markerGraphics;if(!m)return;let y=0;if(t.scaleSymbolsProportionally){const a=t.frame;a&&(y=a.ymax-a.ymin)}for(const a of m)if(a){const u=a.symbol;if(!u)continue;switch(u.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":$e(t,i,a,o,e,r,n,s,l,c,y,f);break;case"CIMTextSymbol":Pe(t,i,a,e,o,r,n,l,c,y)}}}function Pe(t,i,e,o,r,n,s,l,c,f){const m=[];B.findApplicableOverrides(e,r,m);const y=e.geometry;if(!("x"in y)||!("y"in y))return;const a=e.symbol,u=he(a),g=pe(a.fontStyleName),h=Jt(a.fontFamilyName);a.font=j({family:h,decoration:u},g);const S=t.frame,d=y.x-.5*(S.xmin+S.xmax),v=y.y-.5*(S.ymin+S.ymax),N=t.size/f,b=t.primitiveName,M=k(a.height)*N,P=k(a.angle),x=(k(a.offsetX)+d)*N,C=(k(a.offsetY)+v)*N,w=X(I.getFillColor(a));let z=X(I.getStrokeColor(a)),L=I.getStrokeWidth(a);L||(z=X(I.getFillColor(a.haloSymbol)),L=a.haloSize*N);const[F,R]=J(r,b),T=JSON.stringify(t.effects)+Number(t.colorLocked)+JSON.stringify(t.anchorPoint)+t.anchorPointUnits+JSON.stringify(t.markerPlacement),A=O(JSON.stringify(e)+T+R).toString(),H=p(e.primitiveName,o,"TextString",n,e.textString,Rt,a.textCase),{fontStyleName:W}=a,$=h+(W?"-"+W.toLowerCase():"-regular"),G=$;s.push({type:"text",templateHash:A,materialHash:F||typeof H=="function"||H.match(/\[(.*?)\]/)?(V,_,q)=>G+"-"+Yt(H,V,_,q):G+"-"+O(H),cim:a,materialOverrides:null,colorLocked:t.colorLocked,effects:i,alignment:l,anchorPoint:{x:t.anchorPoint?t.anchorPoint.x:0,y:t.anchorPoint?t.anchorPoint.y:0},isAbsoluteAnchorPoint:t.anchorPointUnits!=="Relative",fontName:$,decoration:u,weight:p(b,o,"Weight",n,g.weight),style:p(b,o,"Size",n,g.style),size:p(b,o,"Size",n,M),angle:p(b,o,"Rotation",n,P),offsetX:p(b,o,"OffsetX",n,x),offsetY:p(b,o,"OffsetY",n,C),horizontalAlignment:ue(a.horizontalAlignment),verticalAlignment:ye(a.verticalAlignment),text:H,color:w,outlineColor:z,outlineSize:L,referenceSize:c,sizeRatio:1,markerPlacement:t.markerPlacement})}function $e(t,i,e,o,r,n,s,l,c,f,m,y){const a=e.symbol,u=a.symbolLayers;if(!u)return;if(y)return void xt(t,i,e,r,o,n,s,l,c,f,m);let g=u.length;if(Ie(u))return void we(t,e,u,o,r,n,s,c,f,m);const h=bt.applyEffects(a.effects,e.geometry);if(h)for(;g--;){const d=u[g];if(d&&d.enable!==!1)switch(d.type){case"CIMSolidFill":case"CIMSolidStroke":{var S;const v=bt.applyEffects(d.effects,h),N=dt(v);if(!N)continue;const[b,M,P]=St(N,t.frame,t.size,t.anchorPoint,t.anchorPointUnits!=="Relative"),x=d.type==="CIMSolidFill",C={type:"sdf",geom:v,asFill:x},w=t.primitiveName,z=(S=k(t.size))!=null?S:10,L=k(t.rotation),F=k(t.offsetX),R=k(t.offsetY),T=d.path,A=d.primitiveName,H=X(x?I.getFillColor(d):I.getStrokeColor(d)),W=x?{r:0,g:0,b:0,a:0}:X(I.getStrokeColor(d)),$=I.getStrokeWidth(d);if(!x&&!$)break;let G=!1,V="";for(const E of o)E.primitiveName!==A&&E.primitiveName!==w||(E.value!==void 0?V+=`-${E.primitiveName}-${E.propertyName}-${JSON.stringify(E.value)}`:E.valueExpressionInfo&&(G=!0));const _=JSON.stringify(D(j({},t),{markerGraphics:null})),q=O(JSON.stringify(C)+T).toString(),Pt={type:"marker",templateHash:O(JSON.stringify(e)+JSON.stringify(d)+_+V).toString(),materialHash:G?()=>q:q,cim:C,materialOverrides:null,colorLocked:t.colorLocked,effects:i,scaleSymbolsProportionally:t.scaleSymbolsProportionally,alignment:c,anchorPoint:{x:M,y:P},isAbsoluteAnchorPoint:!1,size:p(t.primitiveName,r,"Size",n,z),rotation:p(t.primitiveName,r,"Rotation",n,L),offsetX:p(t.primitiveName,r,"OffsetX",n,F),offsetY:p(t.primitiveName,r,"OffsetY",n,R),scaleX:1,frameHeight:m,rotateClockwise:t.rotateClockwise,referenceSize:f,sizeRatio:b,color:p(A,r,"Color",n,H,Y),outlineColor:p(A,r,"Color",n,W,Y),outlineWidth:p(A,r,"Width",n,$),markerPlacement:t.markerPlacement,path:T};s.push(Pt);break}default:xt(t,i,e,r,o,n,s,l,c,f,m)}}}function we(t,i,e,o,r,n,s,l,c,f){const m=i.geometry,y=e[0],a=e[1],u=dt(m);if(!u)return;const[g,h,S]=St(u,t.frame,t.size,t.anchorPoint,t.anchorPointUnits!=="Relative"),d={type:"sdf",geom:m,asFill:!0},v=t.primitiveName,N=k(t.size),b=k(t.rotation),M=k(t.offsetX),P=k(t.offsetY),x=a.path,C=a.primitiveName,w=y.primitiveName,z=X(I.getFillColor(a)),L=X(I.getStrokeColor(y)),F=I.getStrokeWidth(y);let R=!1,T="";for(const $ of o)$.primitiveName!==C&&$.primitiveName!==w&&$.primitiveName!==v||($.value!==void 0?T+=`-${$.primitiveName}-${$.propertyName}-${JSON.stringify($.value)}`:$.valueExpressionInfo&&(R=!0));const A=JSON.stringify(D(j({},t),{markerGraphics:null})),H=O(JSON.stringify(d)+x).toString(),W={type:"marker",templateHash:O(JSON.stringify(i)+JSON.stringify(a)+JSON.stringify(y)+A+T).toString(),materialHash:R?()=>H:H,cim:d,materialOverrides:null,colorLocked:t.colorLocked,effects:t.effects,scaleSymbolsProportionally:t.scaleSymbolsProportionally,alignment:l,anchorPoint:{x:h,y:S},isAbsoluteAnchorPoint:!1,size:p(t.primitiveName,r,"Size",n,N),rotation:p(t.primitiveName,r,"Rotation",n,b),offsetX:p(t.primitiveName,r,"OffsetX",n,M),offsetY:p(t.primitiveName,r,"OffsetY",n,P),scaleX:1,frameHeight:f,rotateClockwise:t.rotateClockwise,referenceSize:c,sizeRatio:g,color:p(C,r,"Color",n,z,Y),outlineColor:p(w,r,"Color",n,L,Y),outlineWidth:p(w,r,"Width",n,F),markerPlacement:t.markerPlacement,path:x};s.push(W)}function xt(t,i,e,o,r,n,s,l,c,f,m){const y=Le(t,e);let a=[];const u=["Rotation","OffsetX","OffsetY"];a=r.filter(C=>C.primitiveName!==t.primitiveName||u.indexOf(C.propertyName)===-1);let g="";for(const C of r)C.value!==void 0&&(g+=`-${C.primitiveName}-${C.propertyName}-${JSON.stringify(C.value)}`);const[h,S,d]=I.getTextureAnchor(y,l),v=t.primitiveName,N=k(t.rotation),b=k(t.offsetX),M=k(t.offsetY),P=O(JSON.stringify(y)+g).toString(),x={type:"marker",templateHash:P,materialHash:a.length===0?P:U(P,o,a,n),cim:y,materialOverrides:a,colorLocked:t.colorLocked,effects:i,scaleSymbolsProportionally:t.scaleSymbolsProportionally,alignment:c,anchorPoint:{x:h,y:S},isAbsoluteAnchorPoint:!1,size:t.size,rotation:p(v,o,"Rotation",n,N),offsetX:p(v,o,"OffsetX",n,b),offsetY:p(v,o,"OffsetY",n,M),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:m,rotateClockwise:t.rotateClockwise,referenceSize:f,sizeRatio:d/Ft(t.size),markerPlacement:t.markerPlacement};s.push(x)}function Le(t,i){return{type:t.type,enable:!0,name:t.name,colorLocked:t.colorLocked,primitiveName:t.primitiveName,anchorPoint:t.anchorPoint,anchorPointUnits:t.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:t.rotateClockwise,rotation:0,size:t.size,billboardMode3D:t.billboardMode3D,depth3D:t.depth3D,frame:t.frame,markerGraphics:[i],scaleSymbolsProportionally:t.scaleSymbolsProportionally,respectFrame:t.respectFrame,clippingPath:t.clippingPath}}function nt(t){if(t&&t.indexOf("Level_")===0){const i=parseInt(t.substr(6),10);if(i!==NaN)return i}return 0}function Y(t){if(!t||t.length===0)return null;const i=new At(t).toRgba();return{r:i[0],g:i[1],b:i[2],a:i[3]}}function p(t,i,e,o,r,n,s){const l=i[t];if(l){const c=l[e];if(typeof c=="string"||typeof c=="number"||c instanceof Array)return n?n.call(null,c,s):c;if(c!=null&&c instanceof mt)return(f,m,y)=>{let a=vt(c,f,{$view:y},o.geometryType,m);return a!==null&&n&&(a=n.call(null,a,s)),a!==null?a:r}}return r}function U(t,i,e,o){for(const r of e)if(r.valueExpressionInfo){const n=i[r.primitiveName]&&i[r.primitiveName][r.propertyName];n instanceof mt&&(r.fn=(s,l,c)=>vt(n,s,{$view:c},o.geometryType,l))}return(r,n,s)=>{for(const l of e)l.fn&&(l.value=l.fn(r,n,s));return O(t+B.buildOverrideKey(e)).toString()}}function Ue(t,i){if(!i||i.length===0)return t;const e=JSON.parse(JSON.stringify(t));return B.applyOverrides(e,i),e}function J(t,i){let e=!1,o="";for(const r of t)r.primitiveName===i&&(r.value!==void 0?o+=`-${r.primitiveName}-${r.propertyName}-${JSON.stringify(r.value)}`:r.valueExpressionInfo&&(e=!0));return[e,o]}function Ot(t,i,e){if(t&&i)switch(t.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const o=t.symbolLayers;if(!o)return;for(const r of o)switch(r.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in r&&r.url&&e.push(i.fetchResource(r.url,null));break;case"CIMVectorMarker":{const n=r.markerGraphics;if(!n)continue;for(const s of n)if(s){const l=s.symbol;l&&Ot(l,i,e)}}}}}}const Ie=t=>t&&t.length===2&&t[0].enable&&t[1].enable&&t[0].type==="CIMSolidStroke"&&t[1].type==="CIMSolidFill"&&!t[0].effects&&!t[1].effects,ze={marker:K.MARKER,fill:K.FILL,line:K.LINE,text:K.TEXT};class Xe{constructor(i,e,o,r){const n={minScale:e==null?void 0:e.minScale,maxScale:e==null?void 0:e.maxScale},s=He(n);this.layers=i,this.data=e,this.hash=this._createHash()+s,this.rendererKey=o;const l={isOutline:!1,isOutlinedFill:!1,placement:null,stride:{fill:"default"},vvFlags:o};for(const c of i){const f=ze[c.type];c.materialKey=te(f,l),c.maxVVSize=r,c.scaleInfo=n,c.templateHash+=s}}get type(){return"expanded-cim"}_createHash(){let i="";for(const e of this.layers)i+=e.templateHash;return i}}function He(t){return t.minScale||t.maxScale?t.minScale+"-"+t.maxScale:""}async function Je(t,i,e){if(!t.name)return Promise.reject(new Q("style-symbol-reference-name-missing","Missing name in style symbol reference"));if(t.styleName&&t.styleName==="Esri2DPointSymbolsStyle")return Re(t,e);try{return Ye(await Tt(t,i,e),t.name,i,e)}catch(o){return tt(o),null}}async function Re(t,i){const e=Et.replace(/\{SymbolName\}/gi,t.name);try{const o=await ut(e,i);return yt(o.data)}catch(o){return tt(o),null}}async function Ye(t,i,e,o){const r=t.data,n={portal:e&&e.portal||Wt.getDefault(),url:jt(t.baseUrl),origin:"portal-item"},s=r.items.find(c=>c.name===i);if(!s)throw new Q("symbolstyleutils:symbol-name-not-found",`The symbol name '${i}' could not be found`,{symbolName:i});let l=Gt(Dt(s,"cimRef"),n);ee()&&(l=ie(l));try{const c=await ut(l,o);return yt(c.data)}catch(c){return tt(c),null}}const Mt=async(t,i,e)=>new Xe(await ge(t.data,i,e),t.data,t.rendererKey,t.maxVVSize),Ve=async(t,i,e,o)=>{if(!t)return null;if(t.type==="cim")return Mt(t,i,e);if(t.type==="web-style"){const r={type:"cim",data:await Je(t,null,o),rendererKey:t.rendererKey,maxVVSize:t.maxVVSize};return Mt(r,i,e)}return t};function qe(t){if(!t)return null;const{type:i,cim:e,url:o,materialHash:r}=t,n={cim:e,type:i,mosaicHash:r,url:o,size:null,dashTemplate:null,path:null,text:null,fontName:null};switch(i){case"marker":n.size=t.size,n.path=t.path;break;case"line":n.dashTemplate=t.dashTemplate;break;case"text":n.text=t.text,n.fontName=t.fontName}return n}export{bt as f,qe as i,Ve as l,De as m,Ue as q,re as r,vt as s};
