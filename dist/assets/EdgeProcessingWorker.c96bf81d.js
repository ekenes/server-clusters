var At=Object.defineProperty,It=Object.defineProperties;var bt=Object.getOwnPropertyDescriptors;var tt=Object.getOwnPropertySymbols;var xt=Object.prototype.hasOwnProperty,Vt=Object.prototype.propertyIsEnumerable;var et=(t,e,n)=>e in t?At(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,nt=(t,e)=>{for(var n in e||(e={}))xt.call(e,n)&&et(t,n,e[n]);if(tt)for(var n of tt(e))Vt.call(e,n)&&et(t,n,e[n]);return t},ot=(t,e)=>It(t,bt(e));import{n as Lt}from"./deduplicate.c63f6fac.js";import{y as Nt,u as St,i as Et,c as Ft,l as Ut,p as Wt,o as Bt,m as Dt,T as Mt,h as kt,a as zt,b as jt,d as Ht,A as Pt,O as Ot,x as Tt,g as Ct,w as qt,E as Gt,L as _t,B as Jt,F as Rt,I as Kt,U as Qt,j as Xt,V as Yt,M as Zt,S as te,k as ee,q as ne,v as oe,z as re,C as se,D as ie,G as ae,H as ce}from"./BufferView.57bc1dec.js";import{dV as le,dW as rt,a0 as b,c2 as fe,dX as st,dY as ue,dZ as de,a1 as H,d_ as it,d$ as P,e0 as at,e1 as ge,e2 as pe,e3 as ct,e4 as me}from"./vendor.1906794a.js";import{A as O}from"./InterleavedLayout.bdc84c1d.js";import"./types.0d6a11a5.js";function lt(t,e,n){const s=e/3,r=new Uint32Array(n+1),a=new Uint32Array(n+1),g=(o,i)=>{o<i?r[o+1]++:a[i+1]++};for(let o=0;o<s;o++){const i=t[3*o],u=t[3*o+1],d=t[3*o+2];g(i,u),g(u,d),g(d,i)}let c=0,p=0;for(let o=0;o<n;o++){const i=r[o+1],u=a[o+1];r[o+1]=c,a[o+1]=p,c+=i,p+=u}const l=new Uint32Array(6*s),f=r[n],h=(o,i,u)=>{if(o<i){const d=r[o+1]++;l[2*d]=i,l[2*d+1]=u}else{const d=a[i+1]++;l[2*f+2*d]=o,l[2*f+2*d+1]=u}};for(let o=0;o<s;o++){const i=t[3*o],u=t[3*o+1],d=t[3*o+2];h(i,u,o),h(u,d,o),h(d,i,o)}const w=(o,i)=>{const u=2*o,d=i-o;for(let y=1;y<d;y++){const I=l[u+2*y],L=l[u+2*y+1];let v=y-1;for(;v>=0&&l[u+2*v]>I;v--)l[u+2*v+2]=l[u+2*v],l[u+2*v+3]=l[u+2*v+1];l[u+2*v+2]=I,l[u+2*v+3]=L}};for(let o=0;o<n;o++)w(r[o],r[o+1]),w(f+a[o],f+a[o+1]);const m=new Int32Array(3*s),x=(o,i)=>o===t[3*i]?0:o===t[3*i+1]?1:o===t[3*i+2]?2:-1,$=(o,i)=>{const u=x(o,i);m[3*i+u]=-1},V=(o,i,u,d)=>{const y=x(o,i);m[3*i+y]=d;const I=x(u,d);m[3*d+I]=i};for(let o=0;o<n;o++){let i=r[o];const u=r[o+1];let d=a[o];const y=a[o+1];for(;i<u&&d<y;){const I=l[2*i],L=l[2*f+2*d];I===L?(V(o,l[2*i+1],L,l[2*f+2*d+1]),i++,d++):I<L?($(o,l[2*i+1]),i++):($(L,l[2*f+2*d+1]),d++)}for(;i<u;)$(o,l[2*i+1]),i++;for(;d<y;)$(l[2*f+2*d],l[2*f+2*d+1]),d++}return m}function ft(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:he(t.layout)}}function he(t){const e=new Array;return t.fields.forEach((n,s)=>{const r=ot(nt({},n),{constructor:ut(n.constructor)});e.push([s,r])}),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}const we=[Nt,St,Et,Ft,Ut,Wt,Bt,Dt,Mt,kt,zt,jt,Ht,Pt,Ot,Tt,Ct,qt,Gt,_t,Jt,Rt,Kt,Qt,Xt,Yt,Zt,te,ee,ne,oe,re,se,ie,ae,ce];function ut(t){return`${t.ElementType}_${t.ElementCount}`}const $e=new Map;we.forEach(t=>$e.set(ut(t),t));function T(t,e=0){const n=t.stride;return t.fieldNames.filter(s=>{const r=t.fields.get(s).optional;return!(r&&r.glPadding)}).map(s=>{const r=t.fields.get(s),a=r.constructor.ElementCount,g=ye(r.constructor.ElementType),c=r.offset,p=!(!r.optional||!r.optional.glNormalized);return{name:s,stride:n,count:a,type:g,offset:c,normalized:p,divisor:e}})}function ye(t){const e=ve[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const ve={u8:5121,u16:5123,u32:5125,i8:5120,i16:5122,i32:5124,f32:5126},dt=O().vec3f("position").u16("componentIndex").u16("u16padding"),Ae=O().vec2u8("sideness");T(Ae);const gt=O().vec3f("position0").vec3f("position1").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).u8("u8padding",{glPadding:!0}).u16("u16padding",{glPadding:!0}),C=gt.clone().vec3f("normal"),q=gt.clone().vec3f("normalA").vec3f("normalB");class pt{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?be:Ie}write(e,n,s){const r=this.edgeHashFunction(s);z.seed=r;const a=z.getIntRange(0,255),g=z.getIntRange(0,this.settings.variants-1),c=.7,p=z.getFloat(),l=255*(.5*xe(-(1-Math.min(p/c,1))+Math.max(0,p-c)/(1-c),1.2)+.5);e.position0.setVec(n,s.position0),e.position1.setVec(n,s.position1),e.componentIndex.set(n,s.componentIndex),e.variantOffset.set(n,a),e.variantStroke.set(n,g),e.variantExtension.set(n,l)}trim(e,n){return e.slice(0,n)}}const G=new Float32Array(6),M=new Uint32Array(G.buffer),N=new Uint32Array(1);function Ie(t){const e=G;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],N[0]=5381;for(let n=0;n<M.length;n++)N[0]=31*N[0]+M[n];return N[0]}function be(t){const e=G;e[0]=U(t.position0[0]),e[1]=U(t.position0[1]),e[2]=U(t.position0[2]),e[3]=U(t.position1[0]),e[4]=U(t.position1[1]),e[5]=U(t.position1[2]),N[0]=5381;for(let n=0;n<M.length;n++)N[0]=31*N[0]+M[n];return N[0]}const mt=1e4;function U(t){return Math.round(t*mt)/mt}function xe(t,e){const n=t<0?-1:1;return Math.abs(t)**e*n}class _{constructor(){this.commonWriter=new pt}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return C.createBuffer(e)}write(e,n,s){this.commonWriter.write(e,n,s),le(k,s.faceNormal0,s.faceNormal1),rt(k,k),e.normal.setVec(n,k)}trim(e,n){return this.commonWriter.trim(e,n)}}_.Layout=C,_.glLayout=T(C,1);class J{constructor(){this.commonWriter=new pt}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return q.createBuffer(e)}write(e,n,s){this.commonWriter.write(e,n,s),e.normalA.setVec(n,s.faceNormal0),e.normalB.setVec(n,s.faceNormal1)}trim(e,n){return this.commonWriter.trim(e,n)}}J.Layout=q,J.glLayout=T(q,1);const k=b(),z=new fe,S=-1;function Ve(t,e,n,s=Ue){const r=t.vertices.position,a=t.vertices.componentIndex,g=st(s.anglePlanar),c=st(s.angleSignificantEdge),p=Math.cos(c),l=Math.cos(g),f=R.edge,h=f.position0,w=f.position1,m=f.faceNormal0,x=f.faceNormal1,$=Fe(t),V=Ee(t),o=V.length/4,i=e.allocate(o);let u=0;const d=o,y=n.allocate(d);let I=0,L=0,v=0;const Q=ue(0,o),B=new Float32Array(o);de(B,(E,A,W)=>{r.getVec(V[4*A+0],h),r.getVec(V[4*A+1],w),W[A]=me(h,w)}),Q.sort((E,A)=>B[A]-B[E]);const X=new Array,Y=new Array;for(let E=0;E<o;E++){const A=Q[E],W=B[A],j=V[4*A+0],vt=V[4*A+1],F=V[4*A+2],D=V[4*A+3],Z=D===S;if(r.getVec(j,h),r.getVec(vt,w),Z)H(m,$[3*F+0],$[3*F+1],$[3*F+2]),it(x,m),f.componentIndex=a.get(j),f.cosAngle=P(m,x);else{if(H(m,$[3*F+0],$[3*F+1],$[3*F+2]),H(x,$[3*D+0],$[3*D+1],$[3*D+2]),f.componentIndex=a.get(j),f.cosAngle=P(m,x),Ne(f,l))continue;f.cosAngle<-.9999&&it(x,m)}L+=W,v++,Z||Le(f,p)?(e.write(i,u++,f),X.push(W)):Se(f,g)&&(n.write(y,I++,f),Y.push(W))}const $t=new Float32Array(X.reverse()),yt=new Float32Array(Y.reverse());return{regular:{instancesData:e.trim(i,u),lodInfo:{lengths:$t}},silhouette:{instancesData:n.trim(y,I),lodInfo:{lengths:yt}},averageEdgeLength:L/v}}function Le(t,e){return t.cosAngle<e}function Ne(t,e){return t.cosAngle>e}function Se(t,e){const n=ge(t.cosAngle),s=R.fwd,r=R.ortho;return pe(s,t.position1,t.position0),n*(P(at(r,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}function Ee(t){const e=t.faces.length/3,n=t.faces,s=t.neighbors;let r=0;for(let c=0;c<e;c++){const p=s[3*c+0],l=s[3*c+1],f=s[3*c+2],h=n[3*c+0],w=n[3*c+1],m=n[3*c+2];r+=p===S||h<w?1:0,r+=l===S||w<m?1:0,r+=f===S||m<h?1:0}const a=new Int32Array(4*r);let g=0;for(let c=0;c<e;c++){const p=s[3*c+0],l=s[3*c+1],f=s[3*c+2],h=n[3*c+0],w=n[3*c+1],m=n[3*c+2];(p===S||h<w)&&(a[g++]=h,a[g++]=w,a[g++]=c,a[g++]=p),(l===S||w<m)&&(a[g++]=w,a[g++]=m,a[g++]=c,a[g++]=l),(f===S||m<h)&&(a[g++]=m,a[g++]=h,a[g++]=c,a[g++]=f)}return a}function Fe(t){const e=t.faces.length/3,n=t.vertices.position,s=t.faces,r=K.v0,a=K.v1,g=K.v2,c=new Float32Array(3*e);for(let p=0;p<e;p++){const l=s[3*p+0],f=s[3*p+1],h=s[3*p+2];n.getVec(l,r),n.getVec(f,a),n.getVec(h,g),ct(a,a,r),ct(g,g,r),at(r,a,g),rt(r,r),c[3*p+0]=r[0],c[3*p+1]=r[1],c[3*p+2]=r[2]}return c}const R={edge:{position0:b(),position1:b(),faceNormal0:b(),faceNormal1:b(),componentIndex:0,cosAngle:0},ortho:b(),fwd:b()},K={v0:b(),v1:b(),v2:b()},Ue={anglePlanar:4,angleSignificantEdge:35};async function Te(t){const e=Be(t),n=We(e),s=[e.data.buffer];return{result:De(n,s),transferList:s}}function We(t){const e=Me(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return ht.updateSettings(t.writerSettings),wt.updateSettings(t.writerSettings),Ve(e,ht,wt)}function Be(t){return{data:dt.createView(t.dataBuffer),indices:t.indicesType==="Uint32Array"?new Uint32Array(t.indicesBuffer):t.indicesType==="Uint16Array"?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}function De(t,e){return e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:ft(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:ft(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}function Me(t,e,n,s){if(e)return{faces:n,facesLength:s,neighbors:lt(n,s,t.count),vertices:t};const r=Lt(t.buffer,t.stride/4,{originalIndices:n,originalIndicesLength:s}),a=lt(r.indices,s,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:a,vertices:dt.createView(r.buffer)}}const ht=new _,wt=new J;export{We as work,Te as wrappedWork};
