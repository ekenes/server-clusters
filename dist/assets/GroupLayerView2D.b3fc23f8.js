var b=Object.defineProperty,_=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var p=Object.getOwnPropertySymbols;var v=Object.prototype.hasOwnProperty,m=Object.prototype.propertyIsEnumerable;var g=(e,i,t)=>i in e?b(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,u=(e,i)=>{for(var t in i||(i={}))v.call(i,t)&&g(e,t,i[t]);if(p)for(var t of p(i))m.call(i,t)&&g(e,t,i[t]);return e},f=(e,i)=>_(e,V(i));import{X as h,Y as c,ge as C,Z as w,ci as L,fT as O}from"./vendor.1906794a.js";import{l as T}from"./VertexArrayObject.fb67875c.js";import"./Texture.e5002286.js";import{a as x}from"./WGLContainer.85960f9a.js";import{u as F,l as j}from"./LayerView.31466adc.js";import"./definitions.21e97413.js";import"./Utils.dc5734bd.js";import"./ShaderCompiler.c7c7b63f.js";import"./config.2a39d8a4.js";import"./GeometryUtils.ea8c8742.js";import"./MaterialKey.301bf49f.js";import"./pixelUtils.e90a335a.js";import"./Container.3129b529.js";import"./earcut.f20dd8d8.js";class H extends x{constructor(){super(...arguments),this._lastWidth=0,this._lastHeight=0,this.requiresDedicatedFBO=!1}dispose(){this._renderTarget&&(this._renderTarget.dispose(),this._renderTarget=null)}doRender(i){const t=this.createRenderParams(i),{context:r,painter:s,profiler:a}=t;this._prevFBO=r.getBoundFramebufferObject(),a.recordContainerStart(this.name);const n=this._getFbo(t),o=s.getRenderTarget();r.bindFramebuffer(n),s.setRenderTarget(n),r.setDepthWriteEnabled(!0),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.setClearDepth(1),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT),r.setDepthWriteEnabled(!1);for(const d of this.children)d.beforeRender(i);for(const d of this.children)d.processRender(t);for(const d of this.children)d.afterRender(i);s.setRenderTarget(o),r.bindFramebuffer(this._prevFBO),s.beforeRenderLayer(t,this._clippingInfos?255:0,this.computedOpacity),r.setStencilTestEnabled(!1),r.setStencilWriteMask(0),s.blitTexture(r,n.colorTexture,9728),s.compositeLayer(t,this.computedOpacity),a.recordContainerEnd()}createRenderParams(i){return f(u({},super.createRenderParams(i)),{blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:1})}_getFbo(i){const{context:t,painter:r}=i,{width:s,height:a}=t.getViewport();if(s!==this._lastWidth||a!==this._lastHeight)if(this._lastWidth=s,this._lastHeight=a,this._renderTarget)this._renderTarget.resize(s,a);else{const n={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:s,height:a},o={colorTarget:0,depthStencilTarget:3};this._renderTarget=new T(t,o,n,r.getSharedStencilBuffer())}return this._renderTarget}}let l=class extends F{constructor(e){super(e),this.type="group",this.layerViews=new L}initialize(){this.handles.add([this.layerViews.on("change",e=>this._layerViewsChangeHandler(e)),this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()),this.layer.watch("visibilityMode",()=>this._visibilityModeHandler(),!0),this.watch("visible",()=>this._visibleHandler(),!0)],"grouplayerview"),this._layerViewsChangeHandler({target:null,added:this.layerViews.toArray(),removed:[],moved:[]}),this._layerViewsAfterChangesHandler()}set layerViews(e){this._set("layerViews",O(e,this._get("layerViews")))}isUpdating(){return this.layerViews.some(e=>e.updating)}get updatingProgress(){return this.layerViews.length===0?1:this.layerViews.reduce((e,i)=>e+i.updatingProgress,0)/this.layerViews.length}_hasLayerViewVisibleOverrides(){return this.layerViews.some(e=>e._isOverridden("visible"))}_findLayerViewForLayer(e){return e&&this.layerViews.find(i=>i.layer===e)}_firstVisibleOnLayerOrder(){const e=this.layer.layers.find(i=>{const t=this._findLayerViewForLayer(i);return t&&t.visible});return e&&this._findLayerViewForLayer(e)}_enforceExclusiveVisibility(e){this._hasLayerViewVisibleOverrides()&&(e||!(e=this._firstVisibleOnLayerOrder())&&this.layerViews.length>0&&(e=this._findLayerViewForLayer(this.layer.layers.getItemAt(0))),this.layerViews.forEach(i=>{i.visible=i===e}))}_layerViewsChangeHandler(e){this.handles.remove("grouplayerview:visible"),this.handles.add(this.layerViews.map(r=>r.watch("visible",s=>this._layerViewVisibleHandler(s,r),!0)).toArray(),"grouplayerview:visible");const i=e.added[e.added.length-1];let t=null;i&&i.visible&&(t=i),this._enforceVisibility(t)}_layerViewsAfterChangesHandler(){this.handles.remove("grouplayerview:updating"),this.handles.add(this.layerViews.map(e=>e.watch("updating",()=>this._updateUpdating(),!0)).toArray(),"grouplayerview:updating"),this._updateUpdating()}_enforceVisibility(e){if(this._hasLayerViewVisibleOverrides())switch(this.layer.visibilityMode){case"inherited":{const i=this.visible;this.layerViews.forEach(t=>{t.visible=i});break}case"exclusive":this._enforceExclusiveVisibility(e)}}_visibilityModeHandler(){this._enforceVisibility()}_layerViewVisibleHandler(e,i){if(this._hasLayerViewVisibleOverrides())switch(this.layer.visibilityMode){case"inherited":e!==this.visible&&(i.visible=this.visible);break;case"exclusive":this._enforceExclusiveVisibility(e&&i)}}_visibleHandler(){var e;this._hasLayerViewVisibleOverrides()&&((e=this.layer)==null?void 0:e.visibilityMode)==="inherited"&&this._enforceVisibility()}_updateUpdating(){this.notifyChange("updating")}};h([c({cast:C})],l.prototype,"layerViews",null),h([c()],l.prototype,"view",void 0),h([c({readOnly:!0})],l.prototype,"updatingProgress",null),l=h([w("esri.views.layers.GroupLayerView")],l);const E=l;let y=class extends j(E){constructor(){super(...arguments),this.container=new H}attach(){this._updateStageChildren(),this.handles.add(this.layerViews.on("after-changes",()=>this._updateStageChildren()),"grouplayerview2d")}detach(){this.handles.remove("grouplayerview2d"),this.container.removeAllChildren()}update(e){}moveStart(){}viewChange(){}moveEnd(){}_updateStageChildren(){this.container.removeAllChildren(),this.layerViews.forEach((e,i)=>this.container.addChildAt(e.container,i))}};y=h([w("esri.views.2d.layers.GroupLayerView2D")],y);const K=y;export{K as default};
